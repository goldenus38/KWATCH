# KWATCH v1.0 릴리스 노트

**릴리스일**: 2026-02-13
**버전**: 1.0.0

---

## 개요

KWATCH v1.0은 사이버안전센터 웹사이트 관제 시스템의 첫 번째 정식 릴리스입니다.
약 500개 웹사이트의 **정상 작동 여부**와 **메인페이지 위변조 여부**를 실시간으로 관제하며,
관제실 전면 전광판에 표시할 **Dark Theme 실시간 대시보드**를 제공합니다.

---

## 구현 완료 기능

### Phase 1 ~ 5: 기본 시스템

| 구분 | 기능 | 상세 |
|------|------|------|
| **인프라** | Docker Compose 배포 | PostgreSQL 15 + Redis 7 + Express + Next.js 4개 컨테이너 |
| **인프라** | Git Push 자동 배포 | `git push production master`로 빌드/배포/마이그레이션 자동화 |
| **인증** | JWT 기반 인증 | 로그인/로그아웃, Role 기반 권한 관리 (admin/analyst/viewer) |
| **관리** | 웹사이트 CRUD | 등록/수정/삭제/상세조회, CSV 대량 등록, 카테고리 관리 |
| **모니터링** | HTTP 상태 체크 | HEAD → GET fallback, 상태코드/응답시간 측정, BullMQ 병렬 처리 |
| **스크린샷** | Playwright 캡처 | 1920x1080 스크린샷, 400x225 썸네일 자동 생성 |
| **위변조** | pixelmatch 비교 | 베이스라인 대비 픽셀 단위 유사도 비교, diff 이미지 생성 |
| **알림** | 다채널 알림 | Email (SMTP), Slack (Webhook), Telegram (Bot) |
| **대시보드** | 관제 화면 | Dark Theme, 스크린샷 그리드, 실시간 Socket.IO 연동 |
| **대시보드** | 키오스크 모드 | 전체화면, 자동 로테이션, 이상 우선 표시 |
| **테스트** | 통합 테스트 | Vitest + Supertest, 28개 테스트 케이스 |

### Phase 6: 하이브리드 위변조 탐지 (v1.0 핵심 신규 기능)

#### 문제

기존 pixelmatch 픽셀 비교만으로는 동적 사이트(동영상, 애니메이션, 뉴스 피드, 광고 배너)에서 오탐이 심각했습니다.

- 부산대학교 메인페이지: 동영상 때문에 유사도 52% → 매번 위변조 오탐
- 뉴스 사이트: 기사 썸네일 변경만으로 유사도 하락 → 오탐
- 공공기관 사이트: 팝업 공지사항이 화면을 가림 → 오탐

#### 해결: 3계층 하이브리드 탐지

| 계층 | 방법 | 오탐률 | 가중치 | 탐지 대상 |
|------|------|--------|--------|-----------|
| Layer 1 | **외부 도메인 감사** | 최저 | 0.4 | 스크립트 주입, 피싱 리다이렉트 |
| Layer 2 | **HTML 구조 핑거프린트** | 매우 낮음 | 0.3 | 페이지 구조 변경 (태그 추가/삭제) |
| Layer 3 | **픽셀 비교** (pixelmatch) | 높음 (동적사이트) | 0.3 | 시각적 변화 |

**하이브리드 점수** = pixel × 0.3 + structural × 0.3 + critical × 0.4

#### 효과

```
부산대학교 (동영상 메인페이지):
  기존: pixel_only → 유사도 52% → 위변조 감지 (오탐!)
  개선: hybrid → pixel=52%, structural=100%, critical=100%
       → 종합 = 52×0.3 + 100×0.3 + 100×0.4 = 85.6% → 정상 판정!

해커 공격 (스크립트 주입):
  hybrid → pixel=95%, structural=100%, critical=25% (evil.com 주입)
       → 종합 = 95×0.3 + 100×0.3 + 25×0.4 = 68.5% → 위변조 탐지!
```

#### 심각도별 차등 알림

| 감지 유형 | 심각도 | 연속 횟수 | 예시 |
|-----------|--------|-----------|------|
| 새 외부 도메인 주입 | CRITICAL | **1회** (즉시) | evil.com 스크립트 삽입 |
| 페이지 구조 변경 | CRITICAL | **2회** 연속 | HTML 태그 트리 변경 |
| 픽셀만 변경 | WARNING | **3회** 연속 | 동적 콘텐츠 변화 |

#### 팝업 자동 제거

스크린샷 캡처 전 한국 공공기관 사이트의 팝업을 자동으로 처리합니다:

- **JS dialog**: `alert()`, `confirm()`, `prompt()` 자동 dismiss
- **window.open 팝업**: 차단
- **레이어 팝업**:
  - "오늘 하루 안 보기", "닫기" 등 20+ 한국어 패턴으로 닫기 버튼 클릭
  - `position: fixed/absolute` + `z-index >= 900` 오버레이 요소 DOM 제거
  - 반투명 딤(dim) 배경 레이어 제거
  - `body.style.overflow` 스크롤 잠금 해제

#### 사이트별 동적 영역 제외

관리자가 사이트별로 CSS 셀렉터를 지정하여 동적 영역을 위변조 비교에서 제외할 수 있습니다:

```json
{
  "ignoreSelectors": [".news-ticker", "#visitor-count", ".weather-widget", "video"]
}
```

---

## 신규 파일

| 파일 | 용도 |
|------|------|
| `packages/server/src/services/HtmlAnalysisService.ts` | HTML 구조 핑거프린팅 및 외부 도메인 감사 서비스 |
| `packages/server/src/__tests__/services/HtmlAnalysisService.test.ts` | 단위 테스트 29개 |

## 수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `prisma/schema.prisma` | Website에 `ignoreSelectors`, DefacementBaseline에 `htmlHash`/`structuralHash`/`domainWhitelist`, DefacementCheck에 `structuralScore`/`criticalElementsScore`/`htmlSimilarityScore`/`detectionDetails` 추가 |
| `src/types/index.ts` | `HtmlAnalysisResult`, `HybridDefacementResult`, `DetectionDetails` 인터페이스 추가 |
| `src/config/index.ts` | `hybridWeights`, `htmlAnalysisEnabled` 설정 추가 |
| `src/services/ScreenshotService.ts` | `page.content()` HTML 캡처, 팝업 자동 제거 (`dismissPopups`) |
| `src/services/DefacementService.ts` | `compareWithBaseline` 하이브리드 비교, `updateBaseline` HTML 데이터 저장 |
| `src/services/SchedulerService.ts` | `enqueueDefacementCheck`에 `htmlContent` 파라미터 추가 |
| `src/workers/screenshotWorker.ts` | HTML 전달, 자동 베이스라인 시 HTML 데이터 포함 |
| `src/workers/defacementWorker.ts` | 심각도별 차등 연속 감지 임계값 |
| `src/routes/websites.ts` | `ignoreSelectors` POST/PUT 지원 |
| `package.json` | `cheerio` 의존성 추가 |

---

## 신규 환경변수

| 변수 | 기본값 | 설명 |
|------|--------|------|
| `DEFACEMENT_WEIGHT_PIXEL` | `0.3` | 픽셀 비교 가중치 |
| `DEFACEMENT_WEIGHT_STRUCTURAL` | `0.3` | HTML 구조 비교 가중치 |
| `DEFACEMENT_WEIGHT_CRITICAL` | `0.4` | 외부 도메인 감사 가중치 |
| `HTML_ANALYSIS_ENABLED` | `true` | HTML 분석 활성화 (`false` = pixel_only 모드) |

---

## DB 마이그레이션

v1.0 배포 시 아래 컬럼이 자동으로 추가됩니다 (`prisma db push` 또는 `prisma migrate deploy`):

**websites 테이블:**
- `ignore_selectors` (JSON, nullable) — 사이트별 동적 영역 CSS 셀렉터

**defacement_baselines 테이블:**
- `html_hash` (VARCHAR(64), nullable) — 정규화된 HTML의 SHA-256
- `structural_hash` (VARCHAR(64), nullable) — 태그 트리의 SHA-256
- `domain_whitelist` (JSON, nullable) — 베이스라인 시점 외부 도메인 목록

**defacement_checks 테이블:**
- `structural_score` (DECIMAL(5,2), nullable) — 구조 유사도 점수
- `critical_elements_score` (DECIMAL(5,2), nullable) — 도메인 감사 점수
- `html_similarity_score` (DECIMAL(5,2), nullable) — 하이브리드 종합 점수
- `detection_details` (JSON, nullable) — 상세 탐지 결과

모든 신규 컬럼이 nullable이므로 기존 데이터와 완전 호환됩니다.

---

## 테스트

- 전체: **57개** 테스트 케이스
  - AlertService: 9개
  - MonitoringService: 7개
  - HtmlAnalysisService: **29개** (신규)
  - Routes (alerts, monitoring): 12개
- 타입 체크: `tsc --noEmit` 통과

---

## 배포 절차

```bash
# 1. 운영 서버 초기 설정 (최초 1회)
sudo bash scripts/setup-git-deploy.sh
cp /opt/kwatch/.env.example /opt/kwatch/.env
vi /opt/kwatch/.env

# 2. 개발 PC에서 배포
git push production master

# 3. 관리자 계정 생성 (최초 1회)
HASH=$(docker exec kwatch-server node -e \
  "const bcrypt = require('bcryptjs'); bcrypt.hash('비밀번호', 10).then(h => console.log(h))")
docker exec kwatch-db psql -U kwatch -d kwatch -c \
  "INSERT INTO users (username, password_hash, email, role) VALUES ('admin', '$HASH', 'admin@example.com', 'admin');"

# 4. 확인
docker compose ps
curl http://서버:3001/api/health
```

---

## 알려진 제한사항

- `korea.go.kr`: SSL 인증서 불일치(`ERR_TLS_CERT_ALTNAME_INVALID`)로 모니터링/스크린샷 불가 (사이트 자체 문제)
- 최초 스크린샷 캡처 시 베이스라인이 자동 등록되며, 이 시점의 HTML 데이터가 하이브리드 탐지의 기준이 됩니다
- 기존에 pixel_only로 생성된 베이스라인은 자동으로 pixel_only 모드로 동작합니다 (graceful degradation)
- 새 베이스라인을 수동 갱신하면 HTML 데이터가 포함되어 하이브리드 모드로 전환됩니다
